<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Documenttt</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css"
    />
    <style>
        .charts-css .data {
            padding-top: 10px;
        }
        .container {
            display: flex;
            justify-content: center;
            flex-direction: column;
            vertical-align: middle;
            align-items: center;
            gap: 100px;
        }
        .onlyGraph {
            position: relative;
        }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="onlyGraph" style="width: 600px">
        <h1>¿Cual es el servicio que deseas calificar?</h1>
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="contentBody"></tbody>
        </table>
      </div>

      <h1>¿Recomendaría nuestro producto?</h1>
      <div class="onlyGraph" style="width: 400px;">
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="secondElement"></tbody>
        </table>
      </div>

      <h1>¿Cómo calificaría la calidad del producto?</h1>
      <div class="onlyGraph" style="width: 500px; height: 250px">
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="pqElement"></tbody>
        </table>
      </div>

      <h1>¿Cuál fue su experiencia general con nuestro servicio?</h1>
      <div class="onlyGraph" style="width: 500px; height: 280px">
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="esElement"></tbody>
        </table>
      </div>

      <h1>¿Qué tan rápido y eficiente fue el proceso de atención?</h1>
      <div class="onlyGraph" style="width: 500px">
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="asElement"></tbody>
        </table>
      </div>

      <h1>¿Cómo fue tu experiencia general al interactuar con nuestro personal?</h1>
      <div class="onlyGraph" style="width: 500px; height: 280px">
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="geElement"></tbody>
        </table>
      </div>

      <h1>
        ¿El producto/servicio cumplió con tus expectativas?
      </h1>
      <div class="onlyGraph" style="width: 500px; height: 280px">
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="sxElement"></tbody>
        </table>
      </div>

      <h1>¿Cómo describirías la relación calidad/precio de lo que adquiriste?</h1>
      <div class="onlyGraph" style="width: 500px; height: 280px">
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="qprElement"></tbody>
        </table>
      </div>

      <h1>
        ¿Te gustaría volver a utilizar nuestros servicios/productos ?
      </h1>
      <div class="onlyGraph" style="width: 500px; height: 280px">
        <table
          class="charts-css column multiple show-heading show-labels show-primary-axis data-spacing-20"
        >
          <tbody id="fpElement"></tbody>
        </table>
      </div>

    </div>
  </body>
</html>

<script>
  // listado de los datos de la tabla
  const allCounts = (res) => {
    const keysToCount = [
      "service",
      "pq",
      "rp",
      "es",
      "as",
      "ge",
      "sx",
      "qpr",
      "fp",
    ];

    // transforma el array de objetos a un array de arrays
    const counts = keysToCount.reduce((acc, key) => {
      acc[key] = {};
      return acc;
    }, {});

    // recorre el array de objetos y suma los valores de cada clave se añade de 0 a numero +
    res.forEach((item) => {
      keysToCount.forEach((key) => {
        const value = item[key];
        if (value !== undefined && value !== null) {
          if (counts[key][value]) {
            counts[key][value]++;
          } else {
            counts[key][value] = 1;
          }
        }
      });
    });
    return counts;
  };

  // funcion que recibe los datos de la tabla y los muestra en la tabla
  const printGraph = (service, originalJson, finalDocument) => {
    // Modificar los valores en el objeto original usando los nuevos valores
    for (let key in service) {
      if (originalJson.hasOwnProperty(key)) {
        originalJson[key] = service[key];
      }
    }
    // Crear una nueva instancia de Charts.css
    const srv = Object.keys(originalJson).length;
    const keys = Object.keys(originalJson);
    const values = Object.values(originalJson);
    const max = Math.max(...Object.values(originalJson));
    // Crear la tabla
    let info = "";
    for (let i = 0; i < srv; i++) {
      info += `
      <td style="--size: calc( ${values[i]} / ${max} );">
                  <span class="data"> ${keys[i]} - ${values[i]}  </span>
                  <span class="tooltip"> ${keys[i]} </span>
                </td>
      `;
    }

    finalDocument.innerHTML = `
    <tr id="principal">
        <th scope="row">  </th>
        ${info}
      </tr>
    `;
  };

  fetch("/info")
    .then((res) => res.json())
    .then((res) => {
      const counts = allCounts(res);
      console.log(counts);
      printGraph(
        counts.service,
        {
          Cursos: 0,
          Talleres: 0,
          Webinars: 0,
          Charlas: 0,
          Bootcamps: 0,
          Otros: 0,
        },
        document.getElementById("contentBody")
      );

      printGraph(
        counts["rp"],
        {
          Si: 0,
          No: 0,
        },
        document.getElementById("secondElement")
      );

      printGraph(
        counts["pq"],
        { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
        document.getElementById("pqElement")
      );

      printGraph(
        counts["es"],
        { Mala: 0, 
          Excelente: 0, 
          Buena: 0, 
          Regular: 0 },
        document.getElementById("esElement")
      );

      printGraph(
        counts["as"],
        { Rapido: 0, 
          Regular: 0, 
          Lento: 0 },
        document.getElementById("asElement")
      );

      printGraph(
        counts["ge"],
        { Excelente: 0, 
          Regular: 0, 
          Mala: 0 },
        document.getElementById("geElement")
      );

      printGraph(
        counts['sx'], 
        {Cumplio: 0, 
          Parcial: 0,
          No: 0},
        document.getElementById("sxElement")
        );

      printGraph(
        counts['qpr'],
        {Exelente: 0, 
          Bien: 0,
          Regular: 0,
          Mala: 0},
        document.getElementById("qprElement")
      );

      printGraph(
        counts['fp'],
        {Definitivamente: 0, 
          Probablemente: 0, 
          Noseguro: 0, 
          Noprobable: 0,
          Nodefinitivo: 0}, 
        document.getElementById("fpElement")
      );

    })
    .catch((e) => console.log(e));
</script>
